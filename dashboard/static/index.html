<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SERQET | Nexus Console</title>
    <link href="obsidian.css" rel="stylesheet" />
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        /* Specific overrides for JS-injected content or dynamic states */
        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; border: 1px solid currentColor; }
        .status-pill--ok { color: var(--success); background: rgba(100,255,218,0.1); }
        .status-pill--error { color: var(--danger); background: rgba(255,95,95,0.1); }
        
        .pnl--pos { color: var(--success); }
        .pnl--neg { color: var(--danger); }
        
        /* Strategy Grid specific */
        .strategy__grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .strategy__tile { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; text-align: center; }
        .strategy__tile-label { font-size: 0.65rem; color: var(--text-muted); display: block; }
        .strategy__tile-value { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-main); }

        /* Risk Bar */
        .risk-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .risk-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .risk-fill.warning { background: var(--warning); }
        .risk-fill.danger { background: var(--danger); }
    </style>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <header class="header">
            <div class="brand">
                <svg class="brand__logo" viewBox="0 0 100 100">
                    <path d="M50 20 L55 30 L65 30 L60 40 L65 50 L55 60 L50 80 L45 60 L35 50 L40 40 L35 30 L45 30 Z" fill="currentColor" />
                </svg>
                <div>
                    <div class="brand__title">SERQET</div>
                    <div class="brand__subtitle">NEXUS CONSOLE</div>
                </div>
            </div>
            
            <div class="header__controls">
                <select id="symbol-filter" onchange="updateFilter(this.value)">
                    <option value="ALL">ALL PAIRS</option>
                </select>
                <div class="status-pill status-pill--ok" id="system-status">
                    <div class="status-dot active"></div> ONLINE
                </div>
                <div style="font-family:'JetBrains Mono'; font-size:0.9rem;" id="clock">00:00:00</div>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="layout">
            <!-- LEFT COLUMN (Controls & Stats) -->
            <div class="col">
                <div class="card">
                    <div class="card__header">
                        <div class="card__title">COMMAND</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="flex:1" onclick="sendAction('pause')">‚è∏ PAUSE</button>
                        <button class="btn btn--danger" style="flex:1" onclick="sendAction('flatten')">üõë FLATTEN</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card__header"><div class="card__title">ACCOUNT</div></div>
                    <div class="kpi" style="margin-bottom:12px;">
                        <div class="kpi__label">NET LIQUIDITY</div>
                        <div class="kpi__value" id="net-liq">$0.00</div>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi">
                            <div class="kpi__label">REALIZED</div>
                            <div class="kpi__value" id="realized-pnl">$0.00</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi__label">UNREALIZED</div>
                            <div class="kpi__value" id="unrealized-pnl">$0.00</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card__header"><div class="card__title">PERFORMANCE</div></div>
                    <div class="kpi-grid" style="margin-bottom:12px;">
                        <div class="kpi">
                            <div class="kpi__label">WIN RATE</div>
                            <div class="kpi__value" id="win-rate">0%</div>
                        </div>
                        <div class="kpi">
                            <div class="kpi__label">MAKER %</div>
                            <div class="kpi__value" id="maker-rate">0%</div>
                        </div>
                    </div>
                    <div class="kpi">
                         <div class="kpi__label">SHARPE RATIO</div>
                         <div class="kpi__value" id="sharpe-ratio">0.00</div>
                    </div>
                </div>
            </div>

            <!-- CENTER COLUMN (Tabs & Charts) -->
            <div class="col">
                <div class="tabs">
                    <button class="tabs__btn active" id="btn-equity" onclick="switchTab('equity')">EQUITY</button>
                    <button class="tabs__btn" id="btn-strategy" onclick="switchTab('strategy')">STRATEGY</button>
                    <button class="tabs__btn" id="btn-risk" onclick="switchTab('risk')">RISK</button>
                    <button class="tabs__btn" id="btn-latency" onclick="switchTab('latency')">NETWORK</button>
                    <button class="tabs__btn" id="btn-config" onclick="switchTab('config')">CONFIG</button>
                </div>

                <!-- VIEW: EQUITY -->
                <div id="view-equity" style="flex:1; display:flex; flex-direction:column; gap:20px; height:100%;">
                    <div class="card" style="height:320px;">
                        <div class="card__header"><div class="card__title">GROWTH CURVE</div></div>
                        <div id="equity-chart" style="width:100%; height:100%;"></div>
                    </div>
                    
                    <div class="card card--tall">
                        <div class="card__header"><div class="card__title">POSITIONS</div></div>
                        <div id="positions-list" class="list">
                            <div style="text-align:center; padding:20px; color:var(--text-dim)">Waiting for data...</div>
                        </div>
                    </div>
                </div>

                <!-- OTHER VIEWS (Hidden) -->
                <div id="view-strategy" style="display:none; height:100%;">
                    <div class="card card--tall">
                        <div class="card__header"><div class="card__title">STRATEGY STATE</div></div>
                        <div id="strategy-content" class="list"></div>
                    </div>
                </div>

                <div id="view-risk" style="display:none; height:100%;">
                     <div class="card card--tall">
                        <div class="card__header"><div class="card__title">RISK EXPOSURE</div></div>
                        <div id="risk-content" class="list"></div>
                    </div>
                </div>

                <div id="view-latency" style="display:none; height:100%;">
                     <div class="card card--tall">
                        <div class="card__header"><div class="card__title">SYSTEM HEALTH</div></div>
                        <div id="latency-content" class="list"></div>
                    </div>
                </div>

                <div id="view-config" style="display:none; height:100%;">
                     <div class="card card--tall">
                        <div class="card__header">
                            <div class="card__title">ALGO PARAMETERS</div>
                            <button class="btn" onclick="saveConfig()">üíæ SAVE CHANGES</button>
                        </div>
                        <div id="config-form" class="list" style="padding:10px;">
                            <!-- Form generated by JS -->
                            <div style="text-align:center; padding:20px; color:var(--text-dim)">Loading config...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN (Feed & Logs) -->
            <div class="col">
                <div class="card card--tall">
                    <div class="card__header"><div class="card__title">LIVE FEED</div></div>
                    <div id="trades-list" class="list">
                         <div style="text-align:center; padding:20px; color:var(--text-dim)">Waiting...</div>
                    </div>
                </div>

                <div class="card" style="height: 250px;">
                    <div class="card__header"><div class="card__title">SYSTEM LOG</div></div>
                    <div id="log-list" class="log-panel">
                        <div class="log-line"><span>System initializing...</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Minimal logic to bootstrap, rest handles data
        let socket;
        let currentFilter = 'ALL';
        
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        function updateFilter(val) { currentFilter = val; }
        
        async function sendAction(action) {
             if (action === 'flatten' && !confirm("‚ö†Ô∏è CONFIRM FLATTEN?")) return;
             await fetch(`/api/action/${action}`, { method: 'POST' });
        }

        async function switchTab(name) {
            ['equity', 'strategy', 'risk', 'latency', 'config'].forEach(t => {
                document.getElementById('view-' + t).style.display = t === name ? (t === 'equity' ? 'flex' : 'block') : 'none';
                document.getElementById('btn-' + t).className = t === name ? 'tabs__btn active' : 'tabs__btn';
            });
            window.dispatchEvent(new Event('resize'));
            
            if (name === 'config') loadConfig();
        }
        
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const conf = await res.json();
                const container = document.getElementById('config-form');
                
                let html = '';
                const labels = {
                    'AS_GAMMA': 'Risk Aversion (Gamma)',
                    'AS_KAPPA': 'Inventory Aversion (Kappa)',
                    'RISK_MAX_POSITION_PER_SYMBOL_USD': 'Max Position ($)',
                    'RISK_MAX_POSITION_TOTAL_USD': 'Max Total Exposure ($)',
                    'MIN_PROFIT_BPS': 'Min Profit (BPS)',
                    'MAKER_FEE_BPS': 'Maker Fee (BPS)'
                };
                
                Object.entries(conf).forEach(([key, val]) => {
                    const label = labels[key] || key;
                    html += `
                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-size:0.75rem; color:var(--text-secondary); margin-bottom:5px;">${label}</label>
                            <input type="number" step="0.01" id="conf-${key}" value="${val}" 
                                   style="width:100%; bg:transparent; border:1px solid #333; background:#111; color:#fff; padding:8px; border-radius:4px; font-family:'JetBrains Mono'">
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch(e) {
                console.error(e);
            }
        }
        
        async function saveConfig() {
             const keys = ['AS_GAMMA', 'AS_KAPPA', 'RISK_MAX_POSITION_PER_SYMBOL_USD', 'RISK_MAX_POSITION_TOTAL_USD', 'MIN_PROFIT_BPS', 'MAKER_FEE_BPS'];
             const payload = {};
             keys.forEach(k => {
                 const el = document.getElementById(`conf-${k}`);
                 if(el) payload[k] = parseFloat(el.value);
             });
             
             try {
                 await fetch('/api/config', {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify(payload)
                 });
                 alert("‚úÖ CONFIG SAVED! Strategies will update in ~2s.");
             } catch(e) {
                 alert("‚ùå SAVE FAILED: " + e.message);
             }
        }

        function connect() {
            const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${proto}//${window.location.host}/ws`);
            socket.onopen = () => {
                const el = document.getElementById('system-status');
                el.className = 'status-pill status-pill--ok';
                el.innerHTML = '<div class="status-dot active"></div> ONLINE';
            };
            socket.onmessage = (e) => updateUI(JSON.parse(e.data));
            socket.onclose = () => {
                 const el = document.getElementById('system-status');
                 el.className = 'status-pill status-pill--error';
                 el.innerHTML = '<div class="status-dot"></div> OFFLINE';
                 setTimeout(connect, 2000);
            };
        }

        function updateUI(data) {
            try {
                // Populate Filter
                 const select = document.getElementById('symbol-filter');
                 const known = new Set(Array.from(select.options).map(o => o.value));
                 const incoming = new Set([...Object.keys(data.inventory||{}), ...(data.recent_trades||[]).map(t => t.symbol)]);
                 incoming.forEach(s => {
                     if(!known.has(s)) {
                         const opt = document.createElement('option');
                         opt.value = s; opt.innerText = s.toUpperCase();
                         select.appendChild(opt);
                     }
                 });

                 // KPIs
                 document.getElementById('net-liq').innerText = `$${(data.balance||0).toFixed(2)}`;
                 const rpnl = document.getElementById('realized-pnl');
                 rpnl.innerText = `$${(data.realized_pnl||0).toFixed(2)}`;
                 rpnl.className = `kpi__value ${(data.realized_pnl||0)>=0 ? 'text-success' : 'text-danger'}`;
                 
                 const upnl = document.getElementById('unrealized-pnl');
                 upnl.innerText = `$${(data.unrealized_pnl||0).toFixed(2)}`;
                 upnl.className = `kpi__value ${(data.unrealized_pnl||0)>=0 ? 'text-success' : 'text-danger'}`;
                 
                 document.getElementById('win-rate').innerText = `${(data.win_rate_decision||0).toFixed(1)}%`;
                 document.getElementById('maker-rate').innerText = `${(data.maker_rate||0).toFixed(0)}%`;
                 document.getElementById('sharpe-ratio').innerText = (data.sharpe_ratio||0).toFixed(2);

                 // Positions
                 const posContainer = document.getElementById('positions-list');
                 const inv = data.inventory || {};
                 const filteredInv = Object.entries(inv).filter(([k,v]) => currentFilter === 'ALL' || k === currentFilter);
                 
                 posContainer.innerHTML = filteredInv.length ? '' : '<div style="text-align:center; padding:20px; opacity:0.5">No positions</div>';
                 filteredInv.forEach(([sym, info]) => {
                     const isLong = info.qty > 0;
                     posContainer.innerHTML += `
                        <div class="list__item" style="border-left: 3px solid ${isLong ? 'var(--success)' : 'var(--danger)'}">
                            <div style="font-weight:600">${sym}</div>
                            <div style="text-align:right">
                                <div style="font-size:0.8rem">${info.qty}</div>
                                <div class="${info.pnl>=0?'text-success':'text-danger'}">$${info.pnl.toFixed(2)}</div>
                            </div>
                        </div>
                     `;
                 });

                 // Strategy
                 const stratContainer = document.getElementById('strategy-content');
                 const state = data.strategy_state || {};
                 const filteredState = Object.entries(state).filter(([k,v]) => currentFilter === 'ALL' || k === currentFilter);
                 stratContainer.innerHTML = filteredState.map(([sym, s]) => `
                    <div style="background:rgba(255,255,255,0.02); padding:10px; border-radius:8px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-weight:600; color:var(--primary)">${sym}</span>
                            <span style="font-size:0.75rem; opacity:0.7">${s.regime||'UNK'}</span>
                        </div>
                        <div class="strategy__grid">
                            <div class="strategy__tile"><span class="strategy__tile-label">VOL</span><span>${((s.volatility||0)*10000).toFixed(0)}</span></div>
                            <div class="strategy__tile"><span class="strategy__tile-label">KAPPA</span><span>${(s.kappa||0).toFixed(2)}</span></div>
                        </div>
                    </div>
                 `).join('');

                 // Risk
                 const riskContainer = document.getElementById('risk-content');
                 let totalVal = 0;
                 let riskHtml = '';
                 Object.entries(inv).forEach(([sym, info]) => {
                      const val = Math.abs(info.qty * info.entry);
                      totalVal += val;
                      const pct = Math.min((val/500)*100, 100);
                      riskHtml += `
                        <div style="margin-bottom:12px">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:4px;">
                                <span>${sym}</span>
                                <span>$${val.toFixed(0)} / $500</span>
                            </div>
                            <div class="risk-bar"><div class="risk-fill ${pct>80?'danger':(pct>50?'warning':'')}" style="width:${pct}%"></div></div>
                        </div>
                      `;
                 });
                 const totalPct = Math.min((totalVal/1500)*100, 100);
                 riskContainer.innerHTML = `
                    <div style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px; margin-bottom:15px;">
                        <div style="display:flex; justify-content:space-between;">
                            <span>TOTAL EXPOSURE</span>
                            <span style="color:var(--primary)">$${totalVal.toFixed(0)} / $1500</span>
                        </div>
                        <div class="risk-bar" style="height:8px"><div class="risk-fill ${totalPct>80?'danger':''}" style="width:${totalPct}%"></div></div>
                    </div>
                    ${riskHtml}
                 `;

                 // Latency
                 const latContainer = document.getElementById('latency-content');
                 const health = data.system_health || {};
                 latContainer.innerHTML = Object.entries(health).map(([k,v]) => `
                    <div class="list__item">
                        <span>${k.toUpperCase()}</span>
                        <span class="status-pill status-pill--${v=='OK'?'ok':'error'}">${v}</span>
                    </div>
                 `).join('');

                 // Trades
                 const tradesContainer = document.getElementById('trades-list');
                 const trades = (data.recent_trades || []).filter(t => currentFilter === 'ALL' || t.symbol === currentFilter);
                 tradesContainer.innerHTML = trades.slice(0,50).map(t => {
                     const isBuy = t.side === 'BUY';
                     return `
                        <div class="list__item" style="border-left: 3px solid ${isBuy ? 'var(--success)' : 'var(--danger)'}">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span class="badge ${isBuy?'badge--buy':'badge--sell'}">${t.side}</span>
                                <span style="font-weight:600; width:60px;">${t.symbol}</span>
                            </div>
                            <span class="${t.pnl>=0?'text-success':'text-danger'}">$${t.pnl.toFixed(4)}</span>
                        </div>
                     `;
                 }).join('');

                 // LOGGER
                 const logContainer = document.getElementById('log-list');
                 logContainer.innerHTML = (data.logs||[]).map(l => {
                     let cls = '';
                     if(l.includes('ERROR')) cls = 'log-line--err';
                     else if(l.includes('WARNING')) cls = 'log-line--warn';
                     else if(l.includes('BUY') || l.includes('SELL')) cls = 'log-line--info';
                     return `<div class="log-line ${cls}"><span>${l}</span></div>`;
                 }).join('');

                 // CHART
                 if(data.equity_curve && data.equity_curve.length) {
                     const x = data.equity_curve.map(d => new Date(d.time * 1000));
                     const y = data.equity_curve.map(d => d.equity);
                     const color = '#ffffff'; // White line
                     
                     Plotly.newPlot('equity-chart', [{
                         x: x, y: y, mode: 'lines',
                         line: { color: color, width: 1.5 },
                         fill: 'tozeroy', 
                         fillcolor: 'rgba(255, 255, 255, 0.05)' 
                     }], {
                         paper_bgcolor: 'rgba(0,0,0,0)',
                         plot_bgcolor: 'rgba(0,0,0,0)',
                         margin: { l: 40, r: 10, t: 20, b: 30 },
                         xaxis: { color: '#52525b', gridcolor: '#27272a' }, // Dark grey grid
                         yaxis: { color: '#52525b', gridcolor: '#27272a' },
                         showlegend: false
                     }, { responsive: true, displayModeBar: false });
                 }

            } catch (e) {
                console.error(e);
                document.getElementById('log-list').innerHTML = `<div class="log-line log-line--err">UI ERROR: ${e.message}</div>`;
            }
        }
        
        connect();
    </script>
</body>
</html>
